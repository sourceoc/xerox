<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Cotas Xerox</title>
    <meta name="description" content="Sistema profissional de gerenciamento de cotas de impress√£o para professores">
    <meta name="keywords" content="xerox, impress√£o, cotas, gerenciamento, professores">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com data:;
        img-src 'self' data: blob: https:;
        connect-src 'self' https://api.github.com https://github.com;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
        upgrade-insecure-requests
    ">
    
    <!-- Additional security headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="
        camera=(),
        microphone=(),
        geolocation=(),
        payment=(),
        usb=(),
        magnetometer=(),
        gyroscope=(),
        accelerometer=()
    ">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñ®Ô∏è</text></svg>">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Xerox Manager">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23667eea'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='90' fill='white'>üñ®Ô∏è</text></svg>">
</head>
<body>
    <a href="#main-content" class="skip-link">Pular para conte√∫do principal</a>
    <div class="container">
        <header>
            <h1>üñ®Ô∏è Gerenciamento de Cotas Xerox</h1>
            <div class="header-actions">
                <div class="user-info" id="userInfo">
                    <span id="userName">üë§ Visitante</span>
                </div>
                <button id="themeToggle" class="theme-toggle" aria-label="Alternar tema" title="Alternar entre modo claro e escuro"></button>
                <button id="btnConfiguracoes" class="btn btn-secondary">‚öôÔ∏è Configura√ß√µes</button>
                <button id="btnSincronizar" class="btn btn-primary">üîÑ Sincronizar</button>
                <button id="btnLogout" class="btn btn-secondary" style="display: none;">üö™ Sair</button>
            </div>
        </header>

        <main id="main-content">
            <!-- Dashboard -->
            <section class="dashboard">
                <div class="card">
                    <h3>Total de Usu√°rios</h3>
                    <p class="metric" id="totalUsuarios">0</p>
                </div>
                <div class="card">
                    <h3>Cota Total</h3>
                    <p class="metric" id="cotaTotal">0</p>
                </div>
                <div class="card">
                    <h3>Cota Utilizada</h3>
                    <p class="metric" id="cotaUtilizada">0</p>
                </div>
                <div class="card">
                    <h3>Cota Restante</h3>
                    <p class="metric" id="cotaRestante">0</p>
                </div>
            </section>

            <!-- Filtros -->
            <section class="filtros">
                <input type="text" id="filtroNome" placeholder="Buscar por nome..." aria-label="Filtrar usu√°rios por nome">
                <select id="filtroSetor" aria-label="Filtrar usu√°rios por setor">
                    <option value="">Todos os setores</option>
                </select>
                <input type="date" id="filtroDataInicio" aria-label="Data inicial para filtro">
                <input type="date" id="filtroDataFim" aria-label="Data final para filtro">
                <select id="filtroStatus" aria-label="Filtrar por status da cota">
                    <option value="">Todos os status</option>
                    <option value="baixa">Cota Baixa (&lt;20%)</option>
                    <option value="media">Cota M√©dia (20-60%)</option>
                    <option value="alta">Cota Alta (&gt;60%)</option>
                </select>
                <button id="btnLimparFiltros" class="btn btn-secondary" title="Limpar todos os filtros">üóëÔ∏è</button>
                <button id="btnExportar" class="btn btn-info" title="Exportar relat√≥rio">üìä Exportar</button>
                <button id="btnNovoUsuario" class="btn btn-success">‚ûï Novo Usu√°rio</button>
            </section>

            <!-- Tabela de Usu√°rios -->
            <section class="tabela-usuarios">
                <div class="table-header">
                    <h3>Lista de Usu√°rios</h3>
                    <div class="table-controls">
                        <select id="itensPorPagina" aria-label="Itens por p√°gina">
                            <option value="10">10 por p√°gina</option>
                            <option value="25" selected>25 por p√°gina</option>
                            <option value="50">50 por p√°gina</option>
                            <option value="100">Todos</option>
                        </select>
                    </div>
                </div>
                <table id="tabelaUsuarios" role="table" aria-label="Lista de usu√°rios e suas cotas">
                    <thead>
                        <tr role="row">
                            <th role="columnheader" tabindex="0" data-sort="nome">
                                Nome <span class="sort-indicator" aria-hidden="true">‚ÜïÔ∏è</span>
                            </th>
                            <th role="columnheader" tabindex="0" data-sort="setor">
                                Setor <span class="sort-indicator" aria-hidden="true">‚ÜïÔ∏è</span>
                            </th>
                            <th role="columnheader" tabindex="0" data-sort="cotaTotal">
                                Cota Total <span class="sort-indicator" aria-hidden="true">‚ÜïÔ∏è</span>
                            </th>
                            <th role="columnheader" tabindex="0" data-sort="cotaUsada">
                                Cota Usada <span class="sort-indicator" aria-hidden="true">‚ÜïÔ∏è</span>
                            </th>
                            <th role="columnheader" tabindex="0" data-sort="cotaRestante">
                                Cota Restante <span class="sort-indicator" aria-hidden="true">‚ÜïÔ∏è</span>
                            </th>
                            <th role="columnheader" tabindex="0" data-sort="percentual">
                                % Utilizada <span class="sort-indicator" aria-hidden="true">‚ÜïÔ∏è</span>
                            </th>
                            <th role="columnheader">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody role="rowgroup">
                    </tbody>
                </table>
                <div class="pagination" role="navigation" aria-label="Pagina√ß√£o da tabela">
                    <div class="pagination-info">
                        <span id="paginationInfo">Mostrando 0-0 de 0 usu√°rios</span>
                    </div>
                    <div class="pagination-controls">
                        <button id="btnPrimeiraPagina" class="btn-page" aria-label="Primeira p√°gina" disabled>‚èÆÔ∏è</button>
                        <button id="btnPaginaAnterior" class="btn-page" aria-label="P√°gina anterior" disabled>‚óÄÔ∏è</button>
                        <span id="paginaAtual" class="page-info">P√°gina 1 de 1</span>
                        <button id="btnProximaPagina" class="btn-page" aria-label="Pr√≥xima p√°gina" disabled>‚ñ∂Ô∏è</button>
                        <button id="btnUltimaPagina" class="btn-page" aria-label="√öltima p√°gina" disabled>‚è≠Ô∏è</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Configura√ß√µes -->
    <div id="modalConfiguracoes" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>‚öôÔ∏è Configura√ß√µes</h2>
            <form id="formConfiguracoes">
                <div class="form-group">
                    <label for="tokenGithub">Token do GitHub:</label>
                    <input type="password" id="tokenGithub" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label for="repositorio">Reposit√≥rio:</label>
                    <input type="text" id="repositorio" placeholder="usuario/repositorio">
                </div>
                <button type="submit" class="btn btn-primary">üíæ Salvar</button>
            </form>
        </div>
    </div>

    <!-- Modal Usu√°rio -->
    <div id="modalUsuario" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="tituloModalUsuario">üë§ Novo Usu√°rio</h2>
            <form id="formUsuario">
                <div class="form-group">
                    <label for="nomeUsuario">Nome:</label>
                    <input type="text" id="nomeUsuario" required>
                </div>
                <div class="form-group">
                    <label for="setorUsuario">Setor:</label>
                    <input type="text" id="setorUsuario" required>
                </div>
                <div class="form-group">
                    <label for="cotaTotalUsuario">Cota Total:</label>
                    <input type="number" id="cotaTotalUsuario" required min="0">
                </div>
                <button type="submit" class="btn btn-primary">üíæ Salvar</button>
                <button type="button" id="btnCancelar" class="btn btn-secondary">‚ùå Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Hist√≥rico -->
    <div id="modalHistorico" class="modal">
        <div class="modal-content wide">
            <span class="close">&times;</span>
            <h2 id="tituloModalHistorico">üìä Hist√≥rico de Uso</h2>
            <div class="historico-actions">
                <button id="btnNovoGasto" class="btn btn-success">‚ûï Novo Gasto</button>
            </div>
            <table id="tabelaHistorico">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Quantidade</th>
                        <th>Tipo</th>
                        <th>Descri√ß√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Novo Gasto -->
    <div id="modalNovoGasto" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üí∞ Novo Gasto</h2>
            <form id="formNovoGasto">
                <div class="form-group">
                    <label for="dataGasto">Data:</label>
                    <input type="date" id="dataGasto" required>
                </div>
                <div class="form-group">
                    <label for="quantidadeGasto">Quantidade:</label>
                    <input type="number" id="quantidadeGasto" required min="1">
                </div>
                <div class="form-group">
                    <label for="tipoGasto">Tipo:</label>
                    <select id="tipoGasto" required>
                        <option value="impress√£o">Impress√£o</option>
                        <option value="c√≥pia">C√≥pia</option>
                        <option value="digitaliza√ß√£o">Digitaliza√ß√£o</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="descricaoGasto">Descri√ß√£o:</label>
                    <input type="text" id="descricaoGasto" required>
                </div>
                <button type="submit" class="btn btn-primary">üíæ Salvar</button>
                <button type="button" id="btnCancelarGasto" class="btn btn-secondary">‚ùå Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Editar Cota Usada -->
    <div id="modalEditarCota" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="tituloModalEditarCota">üìù Editar Cota Usada</h2>
            <form id="formEditarCota">
                <div class="form-group">
                    <label for="cotaAtualUsada">Cota Atual Usada:</label>
                    <input type="number" id="cotaAtualUsada" readonly class="readonly-input">
                </div>
                <div class="form-group">
                    <label for="novaCotaUsada">Nova Cota Usada:</label>
                    <input type="number" id="novaCotaUsada" required min="0">
                </div>
                <div class="form-group">
                    <label for="motivoAlteracao">Motivo da Altera√ß√£o:</label>
                    <input type="text" id="motivoAlteracao" placeholder="Ex: Corre√ß√£o de contagem, ajuste manual..." required>
                </div>
                <div class="info-box">
                    <p><strong>Cota Total:</strong> <span id="cotaTotalInfo">0</span></p>
                    <p><strong>Nova Cota Restante:</strong> <span id="novaCotaRestanteInfo">0</span></p>
                </div>
                <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√£o</button>
                <button type="button" id="btnCancelarEditarCota" class="btn btn-secondary">‚ùå Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Login -->
    <div id="modalLogin" class="modal modal-login" role="dialog" aria-labelledby="loginTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="login-header">
                <h2 id="loginTitle">üîê Acesso Restrito</h2>
                <p>Fa√ßa login para acessar o sistema</p>
            </div>
            <form id="formLogin" novalidate>
                <div class="form-group-login">
                    <input type="text" id="loginUsuario" placeholder=" " required autocomplete="username">
                    <label for="loginUsuario">Usu√°rio</label>
                </div>
                <div class="form-group-login">
                    <input type="password" id="loginSenha" placeholder=" " required autocomplete="current-password">
                    <label for="loginSenha">Senha</label>
                </div>
                <div class="login-actions">
                    <button type="submit" class="btn-login-primary">üöÄ Entrar</button>
                </div>
            </form>
            <div class="login-footer">
                <p><strong>Usu√°rio:</strong> admin | <strong>Senha:</strong> Ser√° gerada automaticamente no primeiro acesso</p>
                <p class="security-notice">‚ö†Ô∏è A senha tempor√°ria ser√° exibida apenas uma vez. Altere-a imediatamente!</p>
            </div>
        </div>
    </div>

    <!-- Modal Alterar Senha -->
    <div id="modalAlterarSenha" class="modal" role="dialog" aria-labelledby="alterarSenhaTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" aria-label="Fechar modal">&times;</span>
            <h2 id="alterarSenhaTitle">üîë Alterar Senha</h2>
            <form id="formAlterarSenha" novalidate>
                <div class="form-group">
                    <label for="senhaAtual">Senha Atual:</label>
                    <input type="password" id="senhaAtual" required autocomplete="current-password">
                </div>
                <div class="form-group">
                    <label for="novaSenha">Nova Senha:</label>
                    <input type="password" id="novaSenha" required autocomplete="new-password" minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmarSenha">Confirmar Nova Senha:</label>
                    <input type="password" id="confirmarSenha" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn btn-primary">üíæ Alterar Senha</button>
                <button type="button" id="btnCancelarSenha" class="btn btn-secondary">‚ùå Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Exportar -->
    <div id="modalExportar" class="modal" role="dialog" aria-labelledby="exportarTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" aria-label="Fechar modal">&times;</span>
            <h2 id="exportarTitle">üìä Exportar Relat√≥rio</h2>
            <form id="formExportar">
                <div class="form-group">
                    <label for="tipoRelatorio">Tipo de Relat√≥rio:</label>
                    <select id="tipoRelatorio" required>
                        <option value="completo">Relat√≥rio Completo</option>
                        <option value="resumo">Resumo Executivo</option>
                        <option value="cotas-baixas">Apenas Cotas Baixas</option>
                        <option value="historico">Hist√≥rico de Consumo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="formatoExportar">Formato:</label>
                    <select id="formatoExportar" required>
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel (.xlsx)</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="periodoInicio">Per√≠odo Inicial:</label>
                    <input type="date" id="periodoInicio">
                </div>
                <div class="form-group">
                    <label for="periodoFim">Per√≠odo Final:</label>
                    <input type="date" id="periodoFim">
                </div>
                <button type="submit" class="btn btn-primary">üì• Exportar</button>
                <button type="button" id="btnCancelarExportar" class="btn btn-secondary">‚ùå Cancelar</button>
            </form>
        </div>
    </div>

    <script src="js/error-handler.js"></script>
    <script src="js/xss-sanitizer.js"></script>
    <script src="js/crypto-utils.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/validation.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/export.js"></script>
    <script src="script.js"></script>
    
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registrado:', registration);
                    
                    // Verificar por atualiza√ß√µes
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                ToastSystem.show(
                                    'Nova vers√£o dispon√≠vel! Recarregue a p√°gina para atualizar.',
                                    'info',
                                    0,
                                    [
                                        {
                                            text: 'Atualizar',
                                            callback: 'window.location.reload()'
                                        }
                                    ]
                                );
                            }
                        });
                    });
                } catch (error) {
                    console.error('Erro ao registrar Service Worker:', error);
                }
            });
        }
        
        // Detectar instala√ß√£o do PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar toast para instala√ß√£o
            ToastSystem.show(
                'Instale o app para acesso r√°pido!',
                'info',
                8000,
                [
                    {
                        text: 'Instalar',
                        callback: 'installPWA()'
                    }
                ]
            );
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') {
                        ToastSystem.success('App instalado com sucesso!');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // Detectar quando o app √© instalado
        window.addEventListener('appinstalled', () => {
            ToastSystem.success('App instalado! Agora voc√™ pode acess√°-lo pela tela inicial.');
            deferredPrompt = null;
        });
    </script>
</body>
</html>